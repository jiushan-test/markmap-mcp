# 配置说明

## 环境变量配置

### 必需的环境变量（共5个）

本项目需要配置以下5个环境变量才能正常运行：

#### 1. DashScope API（通义千问）

```bash
DASHSCOPE_API_KEY=sk-your-dashscope-api-key
# 或者
QWEN_API_KEY=sk-your-qwen-api-key
```

**获取方式：**

1. 访问 [阿里云 DashScope 控制台](https://dashscope.console.aliyun.com/)
2. 注册/登录阿里云账号
3. 开通 DashScope 服务
4. 创建 API Key

#### 2. 阿里云 OSS（对象存储）

```bash
OSS_ACCESS_KEY_ID=your-oss-access-key-id
OSS_ACCESS_KEY_SECRET=your-oss-access-key-secret
```

**获取方式：**

1. 访问 [阿里云 OSS 控制台](https://oss.console.aliyun.com/)
2. 创建 Bucket（或使用现有的）
3. 获取 AccessKey（推荐使用 RAM 子账号）

**注意：** OSS 的存储桶、区域、端点等配置已在代码中预设，无需配置环境变量。

#### 3. Minio 对象存储

```bash
MINIO_ACCESS_KEY=your-minio-access-key
MINIO_SECRET_KEY=your-minio-secret-key
```

**注意：** Minio 的端点、存储桶、预览URL等配置已在代码中预设，无需配置环境变量。

### 可选的环境变量

#### 临时文件输出目录

```bash
MARKMAP_DIR=/path/to/output/directory
# Windows 示例
MARKMAP_DIR=D:\mindmaps
# macOS/Linux 示例
MARKMAP_DIR=/Users/username/mindmaps
```

如果不配置，将使用系统临时目录。

## 配置方法

### 方法 1：Claude Desktop 配置文件

编辑 Claude Desktop 的配置文件（通常在 `~/Library/Application Support/Claude/` 或 `%APPDATA%\Claude\`）：

```json
{
  "mcpServers": {
    "markmap": {
      "type": "stdio",
      "command": "npx",
      "args": ["-y", "@jiushan93/markmap-mcp-server"],
      "env": {
        "DASHSCOPE_API_KEY": "sk-your-dashscope-api-key",
        "OSS_ACCESS_KEY_ID": "your-oss-access-key-id",
        "OSS_ACCESS_KEY_SECRET": "your-oss-access-key-secret",
        "MINIO_ACCESS_KEY": "your-minio-access-key",
        "MINIO_SECRET_KEY": "your-minio-secret-key"
      }
    }
  }
}
```

### 方法 2：环境变量文件（开发）

在项目根目录创建 `.env` 文件：

```bash
# DashScope API
DASHSCOPE_API_KEY=sk-your-dashscope-api-key

# 阿里云 OSS
OSS_ACCESS_KEY_ID=your-oss-access-key-id
OSS_ACCESS_KEY_SECRET=your-oss-access-key-secret

# Minio
MINIO_ACCESS_KEY=your-minio-access-key
MINIO_SECRET_KEY=your-minio-secret-key

# 可选：输出目录
MARKMAP_DIR=/path/to/output
```

**注意：** `.env` 文件已在 `.gitignore` 中，不会被提交到 Git 仓库。

### 方法 3：系统环境变量

#### Windows

```cmd
setx DASHSCOPE_API_KEY "sk-your-dashscope-api-key"
setx OSS_ACCESS_KEY_ID "your-oss-access-key-id"
setx OSS_ACCESS_KEY_SECRET "your-oss-access-key-secret"
setx MINIO_ACCESS_KEY "your-minio-access-key"
setx MINIO_SECRET_KEY "your-minio-secret-key"
```

#### Linux/macOS

编辑 `~/.bashrc` 或 `~/.zshrc`：

```bash
export DASHSCOPE_API_KEY="sk-your-dashscope-api-key"
export OSS_ACCESS_KEY_ID="your-oss-access-key-id"
export OSS_ACCESS_KEY_SECRET="your-oss-access-key-secret"
export MINIO_ACCESS_KEY="your-minio-access-key"
export MINIO_SECRET_KEY="your-minio-secret-key"
```

然后执行：

```bash
source ~/.bashrc  # 或 source ~/.zshrc
```

## 预设配置

以下配置已在代码中硬编码，**无需配置环境变量**：

### 通义千问 AI

- 模型：`qwen3-235b-a22b-thinking-2507`
- API 端点：`dashscope.aliyuncs.com`
- API URL：`https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions`

### 阿里云 OSS

- 存储桶：`aiagenttest`
- 区域：`oss-cn-beijing`
- 端点：`oss-cn-beijing.aliyuncs.com`

### Minio 对象存储

- 端点：`119.45.11.171`
- 存储桶：`page`
- 预览 URL 基础路径：`http://page.thingotech.com.cn/page`
- 使用 SSL：`false`

## 配置验证

启动项目后，检查日志输出：

```
初始化Qwen API客户端
使用模型: qwen3-235b-a22b-thinking-2507
API端点: dashscope.aliyuncs.com

初始化OSS上传器
OSS Bucket: aiagenttest
OSS Region: oss-cn-beijing
OSS Endpoint: oss-cn-beijing.aliyuncs.com

初始化Minio上传器
Minio端点: 119.45.11.171
Minio存储桶: page
Minio预览URL基础路径: http://page.thingotech.com.cn/page
```

如果看到以下警告，说明缺少必需的环境变量：

```
Qwen API密钥未配置，将无法使用AI生成功能
请配置环境变量: DASHSCOPE_API_KEY 或 QWEN_API_KEY

OSS密钥未配置，将无法使用OSS上传功能
请配置环境变量: OSS_ACCESS_KEY_ID 和 OSS_ACCESS_KEY_SECRET

Minio密钥未配置，将无法使用Minio上传功能
请配置环境变量: MINIO_ACCESS_KEY 和 MINIO_SECRET_KEY
```

## 安全建议

1. **不要在代码中硬编码密钥** - 始终使用环境变量
2. **不要提交密钥到 Git** - 确保 `.env` 文件在 `.gitignore` 中
3. **使用 RAM 子账号** - 为 OSS 创建专用的 RAM 子账号，限制权限
4. **定期轮换密钥** - 定期更新 API 密钥以提高安全性
5. **限制密钥权限** - 只授予必要的权限

## 故障排除

### 问题 1：提示缺少环境变量

**解决方法：**

1. 检查环境变量是否正确配置
2. 检查变量名是否拼写正确
3. 重启应用程序以加载新的环境变量

### 问题 2：OSS 上传失败

**可能原因：**

- OSS Access Key 错误
- OSS 存储桶不存在或无权限
- 网络连接问题

**解决方法：**

1. 验证 OSS Access Key 是否正确
2. 检查 OSS 存储桶 `aiagenttest` 是否存在
3. 检查网络连接

### 问题 3：Minio 上传失败

**可能原因：**

- Minio Access Key 错误
- Minio 服务不可用
- 网络连接问题

**解决方法：**

1. 验证 Minio Access Key 是否正确
2. 检查 Minio 服务是否正常运行
3. 即使 Minio 上传失败，系统会自动降级使用 OSS 链接

### 问题 4：通义千问 API 调用失败

**可能原因：**

- DashScope API Key 错误
- API 配额用尽
- 网络连接问题

**解决方法：**

1. 验证 DashScope API Key 是否正确
2. 检查 API 配额
3. 检查网络连接

## 联系支持

如果遇到其他问题，请：

1. 查看项目的 [GitHub Issues](https://github.com/jiushan-test/markmap-mcp/issues)
2. 提交新的 Issue 并提供详细的错误日志
3. 参考 [README_zh-CN.md](./README_zh-CN.md) 文档

---

**最后更新：** 2025-10-17  
**版本：** v0.2.8
