# Bug ä¿®å¤è¯´æ˜ - Minio ä¸Šä¼ å¤±è´¥é—®é¢˜

## ğŸ› é—®é¢˜æè¿°

åœ¨ v0.2.8 ç‰ˆæœ¬ä¸­ï¼Œæ€ç»´å¯¼å›¾ç”ŸæˆåŠŸèƒ½å¯ä»¥æ­£å¸¸å·¥ä½œï¼Œä½† Minio ä¸Šä¼ æ€»æ˜¯å¤±è´¥ï¼Œå¯¼è‡´è¿”å›çš„ä¸¤ä¸ªé“¾æ¥ï¼ˆdownloadUrl å’Œ previewUrlï¼‰ç›¸åŒï¼Œéƒ½æŒ‡å‘ OSSã€‚

**å®é™…è¿”å›å€¼ï¼š**

```json
{
  "success": true,
  "downloadUrl": "http://aiagenttest.oss-cn-beijing.aliyuncs.com/markmap/xxx.html?...",
  "previewUrl": "http://aiagenttest.oss-cn-beijing.aliyuncs.com/markmap/xxx.html?...",
  "message": "æ€ç»´å¯¼å›¾ç”Ÿæˆå¹¶ä¸Šä¼ æˆåŠŸï¼ˆä»…OSSï¼ŒMinioä¸Šä¼ å¤±è´¥ï¼‰"
}
```

## ğŸ” é—®é¢˜åˆ†æ

é€šè¿‡è¯Šæ–­æµ‹è¯•å‘ç°ï¼š

1. âœ… Minio æœåŠ¡å™¨è¿æ¥æ­£å¸¸
2. âœ… Minio å­˜å‚¨æ¡¶å¯ç”¨
3. âœ… Minio ä¸Šä¼ åŠŸèƒ½æ­£å¸¸ï¼ˆå•ç‹¬æµ‹è¯•ï¼‰
4. âŒ åœ¨å®é™…ä½¿ç”¨ä¸­ Minio ä¸Šä¼ å¤±è´¥

### æ ¹æœ¬åŸå› 

æ£€æŸ¥ä»£ç å‘ç°é—®é¢˜å‡ºåœ¨æ–‡ä»¶ä¸Šä¼ çš„æ‰§è¡Œé¡ºåºä¸Šï¼š

**åŸä»£ç æµç¨‹**ï¼ˆ`src/markmap/createMarkmap.ts`ï¼‰ï¼š

```
1. ç”Ÿæˆ HTML æ–‡ä»¶
2. ä¸Šä¼ åˆ° OSS âœ…
3. åˆ é™¤æœ¬åœ°æ–‡ä»¶ âŒ <- é—®é¢˜åœ¨è¿™é‡Œï¼
4. å°è¯•ä¸Šä¼ åˆ° Minio âŒ <- æ–‡ä»¶å·²è¢«åˆ é™¤ï¼Œä¸Šä¼ å¤±è´¥
```

**å…·ä½“ä»£ç ä½ç½®**ï¼š

```typescript:src/markmap/createMarkmap.ts
// Line 487-503
ossUrl = uploadResult.url;
uploadedToOSS = true;
logger.info(`æ–‡ä»¶å·²æˆåŠŸä¸Šä¼ åˆ°OSS: ${ossUrl}`);

// æ¸…ç†æœ¬åœ°ä¸´æ—¶æ–‡ä»¶çš„æ¡ä»¶
const shouldCleanup = forceOSSUpload || (!openIt && !output);

if (shouldCleanup) {
    try {
        await fs.unlink(filePath);  // âŒ è¿‡æ—©åˆ é™¤æ–‡ä»¶ï¼
        logger.info(`å·²æ¸…ç†æœ¬åœ°ä¸´æ—¶HTMLæ–‡ä»¶: ${filePath}`);
    } catch (cleanupError) {
        logger.warn(`æ¸…ç†ä¸´æ—¶HTMLæ–‡ä»¶å¤±è´¥: ${cleanupError}`);
    }
}

// Line 522-540
// å¦‚æœæä¾›äº†Minioä¸Šä¼ å™¨ï¼Œåˆ™ä¸Šä¼ åˆ°Minioå­˜å‚¨
if (minioUploader) {
    try {
        logger.info("æ£€æµ‹åˆ°Minioä¸Šä¼ å™¨ï¼Œå¼€å§‹ä¸Šä¼ æ–‡ä»¶åˆ°Minio");
        const fileName = basename(filePath);
        const uploadResult = await minioUploader.uploadFile(
            filePath,  // âŒ æ–‡ä»¶å·²ç»ä¸å­˜åœ¨äº†ï¼
            fileName
        );
        ...
    }
}
```

## âœ… è§£å†³æ–¹æ¡ˆ

### ä¿®æ”¹ç­–ç•¥

å°†æ–‡ä»¶åˆ é™¤æ“ä½œç§»åˆ°**æ‰€æœ‰ä¸Šä¼ å®Œæˆå**ï¼š

```
1. ç”Ÿæˆ HTML æ–‡ä»¶
2. ä¸Šä¼ åˆ° OSS âœ…
3. ä¸Šä¼ åˆ° Minio âœ…
4. åˆ é™¤æœ¬åœ°æ–‡ä»¶ âœ…
```

### ä»£ç ä¿®æ”¹

**ä¿®æ”¹ä½ç½® 1**ï¼šç§»é™¤ OSS ä¸Šä¼ åçš„æ–‡ä»¶åˆ é™¤

```diff
ossUrl = uploadResult.url;
uploadedToOSS = true;
logger.info(`æ–‡ä»¶å·²æˆåŠŸä¸Šä¼ åˆ°OSS: ${ossUrl}`);

- // æ¸…ç†æœ¬åœ°ä¸´æ—¶æ–‡ä»¶çš„æ¡ä»¶
- const shouldCleanup = forceOSSUpload || (!openIt && !output);
-
- if (shouldCleanup) {
-     try {
-         await fs.unlink(filePath);
-         logger.info(`å·²æ¸…ç†æœ¬åœ°ä¸´æ—¶HTMLæ–‡ä»¶: ${filePath}`);
-     } catch (cleanupError) {
-         logger.warn(`æ¸…ç†ä¸´æ—¶HTMLæ–‡ä»¶å¤±è´¥: ${cleanupError}`);
-     }
- }
```

**ä¿®æ”¹ä½ç½® 2**ï¼šåœ¨ Minio ä¸Šä¼ åæ·»åŠ æ–‡ä»¶åˆ é™¤

```diff
// å¦‚æœæä¾›äº†Minioä¸Šä¼ å™¨ï¼Œåˆ™ä¸Šä¼ åˆ°Minioå­˜å‚¨
if (minioUploader) {
    try {
        logger.info("æ£€æµ‹åˆ°Minioä¸Šä¼ å™¨ï¼Œå¼€å§‹ä¸Šä¼ æ–‡ä»¶åˆ°Minio");
        const fileName = basename(filePath);
        const uploadResult = await minioUploader.uploadFile(
            filePath,
            fileName
        );
        minioUrl = uploadResult.url;
        uploadedToMinio = true;
        logger.info(`æ–‡ä»¶å·²æˆåŠŸä¸Šä¼ åˆ°Minio: ${minioUrl}`);
    } catch (uploadError: any) {
        logger.error(`ä¸Šä¼ åˆ°Minioå¤±è´¥: ${uploadError.message}`);
        logger.warn("å°†ç»§ç»­ï¼Œä½†Minioé¢„è§ˆé“¾æ¥ä¸å¯ç”¨");
    }
}

+ // æ¸…ç†æœ¬åœ°ä¸´æ—¶æ–‡ä»¶ï¼ˆåœ¨æ‰€æœ‰ä¸Šä¼ å®Œæˆåï¼‰
+ // æ¡ä»¶ï¼š1. å¼ºåˆ¶OSSä¸Šä¼ æ¨¡å¼ä¸‹ï¼Œæ€»æ˜¯æ¸…ç†  2. æˆ–è€…ï¼šä¸éœ€è¦åœ¨æœ¬åœ°æ‰“å¼€ ä¸” æ²¡æœ‰æŒ‡å®šè¾“å‡ºè·¯å¾„
+ const shouldCleanup = forceOSSUpload || (!openIt && !output);
+ if (shouldCleanup && (uploadedToOSS || uploadedToMinio)) {
+     try {
+         await fs.unlink(filePath);
+         logger.info(`å·²æ¸…ç†æœ¬åœ°ä¸´æ—¶HTMLæ–‡ä»¶: ${filePath}`);
+     } catch (cleanupError) {
+         logger.warn(`æ¸…ç†ä¸´æ—¶HTMLæ–‡ä»¶å¤±è´¥: ${cleanupError}`);
+     }
+ }
```

## ğŸ“Š ä¿®å¤åçš„é¢„æœŸç»“æœ

ä¿®å¤åï¼Œåº”è¯¥è¿”å›ä¸¤ä¸ªä¸åŒçš„é“¾æ¥ï¼š

```json
{
  "success": true,
  "downloadUrl": "https://aiagenttest.oss-cn-beijing.aliyuncs.com/markmap/xxx.html?Expires=...",
  "previewUrl": "http://page.thingotech.com.cn/page/xxx.html",
  "filename": "xxx.html",
  "timestamp": "2025-10-17T...",
  "message": "æ€ç»´å¯¼å›¾ç”Ÿæˆå¹¶ä¸Šä¼ æˆåŠŸï¼ˆOSS + Minioï¼‰" // âœ… åŒä¸Šä¼ æˆåŠŸ
}
```

**ä¸¤ä¸ªé“¾æ¥çš„åŒºåˆ«**ï¼š

- `downloadUrl`: OSS é“¾æ¥ï¼ˆé•¿æœŸæœ‰æ•ˆï¼Œ5å¹´ç­¾åURLï¼‰
- `previewUrl`: Minio é“¾æ¥ï¼ˆç®€çŸ­ï¼Œå¿«é€Ÿè®¿é—®ï¼‰

## ğŸ§ª éªŒè¯æ­¥éª¤

1. é‡æ–°ç¼–è¯‘ä»£ç ï¼š`npm run build`
2. é‡æ–°å‘å¸ƒç‰ˆæœ¬ï¼š`npm version patch` æˆ–ç›´æ¥å‘å¸ƒ v0.2.9
3. åœ¨ Claude Desktop ä¸­æµ‹è¯•
4. éªŒè¯è¿”å›å€¼ä¸­çš„ä¸¤ä¸ªé“¾æ¥ä¸åŒ

## ğŸ“ ç‰ˆæœ¬è¯´æ˜

- **Bug ç‰ˆæœ¬**: v0.2.8
- **ä¿®å¤ç‰ˆæœ¬**: v0.2.9ï¼ˆå¾…å‘å¸ƒï¼‰
- **å½±å“èŒƒå›´**: Minio ä¸Šä¼ åŠŸèƒ½
- **ä¸¥é‡ç¨‹åº¦**: ä¸­ç­‰ï¼ˆæ ¸å¿ƒåŠŸèƒ½æ­£å¸¸ï¼Œä½†ç¼ºå°‘å¿«é€Ÿé¢„è§ˆé“¾æ¥ï¼‰

## ğŸ¯ æ€»ç»“

è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„**æ—¶åºé—®é¢˜**ï¼ˆRace Conditionï¼‰ï¼Œç”±äºè¿‡æ—©åœ°æ¸…ç†èµ„æºå¯¼è‡´åç»­æ“ä½œå¤±è´¥ã€‚ä¿®å¤æ–¹æ¡ˆå¾ˆç®€å•ï¼š**ç¡®ä¿æ‰€æœ‰éœ€è¦ä½¿ç”¨æ–‡ä»¶çš„æ“ä½œå®Œæˆåï¼Œå†åˆ é™¤æ–‡ä»¶**ã€‚

---

**ä¿®å¤æ—¥æœŸ**: 2025-10-17  
**ä¿®å¤äººå‘˜**: AI Assistant
