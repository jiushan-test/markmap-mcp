# Bug 修复说明 - Minio 上传失败问题

## 🐛 问题描述

在 v0.2.8 版本中，思维导图生成功能可以正常工作，但 Minio 上传总是失败，导致返回的两个链接（downloadUrl 和 previewUrl）相同，都指向 OSS。

**实际返回值：**

```json
{
  "success": true,
  "downloadUrl": "http://aiagenttest.oss-cn-beijing.aliyuncs.com/markmap/xxx.html?...",
  "previewUrl": "http://aiagenttest.oss-cn-beijing.aliyuncs.com/markmap/xxx.html?...",
  "message": "思维导图生成并上传成功（仅OSS，Minio上传失败）"
}
```

## 🔍 问题分析

通过诊断测试发现：

1. ✅ Minio 服务器连接正常
2. ✅ Minio 存储桶可用
3. ✅ Minio 上传功能正常（单独测试）
4. ❌ 在实际使用中 Minio 上传失败

### 根本原因

检查代码发现问题出在文件上传的执行顺序上：

**原代码流程**（`src/markmap/createMarkmap.ts`）：

```
1. 生成 HTML 文件
2. 上传到 OSS ✅
3. 删除本地文件 ❌ <- 问题在这里！
4. 尝试上传到 Minio ❌ <- 文件已被删除，上传失败
```

**具体代码位置**：

```typescript:src/markmap/createMarkmap.ts
// Line 487-503
ossUrl = uploadResult.url;
uploadedToOSS = true;
logger.info(`文件已成功上传到OSS: ${ossUrl}`);

// 清理本地临时文件的条件
const shouldCleanup = forceOSSUpload || (!openIt && !output);

if (shouldCleanup) {
    try {
        await fs.unlink(filePath);  // ❌ 过早删除文件！
        logger.info(`已清理本地临时HTML文件: ${filePath}`);
    } catch (cleanupError) {
        logger.warn(`清理临时HTML文件失败: ${cleanupError}`);
    }
}

// Line 522-540
// 如果提供了Minio上传器，则上传到Minio存储
if (minioUploader) {
    try {
        logger.info("检测到Minio上传器，开始上传文件到Minio");
        const fileName = basename(filePath);
        const uploadResult = await minioUploader.uploadFile(
            filePath,  // ❌ 文件已经不存在了！
            fileName
        );
        ...
    }
}
```

## ✅ 解决方案

### 修改策略

将文件删除操作移到**所有上传完成后**：

```
1. 生成 HTML 文件
2. 上传到 OSS ✅
3. 上传到 Minio ✅
4. 删除本地文件 ✅
```

### 代码修改

**修改位置 1**：移除 OSS 上传后的文件删除

```diff
ossUrl = uploadResult.url;
uploadedToOSS = true;
logger.info(`文件已成功上传到OSS: ${ossUrl}`);

- // 清理本地临时文件的条件
- const shouldCleanup = forceOSSUpload || (!openIt && !output);
-
- if (shouldCleanup) {
-     try {
-         await fs.unlink(filePath);
-         logger.info(`已清理本地临时HTML文件: ${filePath}`);
-     } catch (cleanupError) {
-         logger.warn(`清理临时HTML文件失败: ${cleanupError}`);
-     }
- }
```

**修改位置 2**：在 Minio 上传后添加文件删除

```diff
// 如果提供了Minio上传器，则上传到Minio存储
if (minioUploader) {
    try {
        logger.info("检测到Minio上传器，开始上传文件到Minio");
        const fileName = basename(filePath);
        const uploadResult = await minioUploader.uploadFile(
            filePath,
            fileName
        );
        minioUrl = uploadResult.url;
        uploadedToMinio = true;
        logger.info(`文件已成功上传到Minio: ${minioUrl}`);
    } catch (uploadError: any) {
        logger.error(`上传到Minio失败: ${uploadError.message}`);
        logger.warn("将继续，但Minio预览链接不可用");
    }
}

+ // 清理本地临时文件（在所有上传完成后）
+ // 条件：1. 强制OSS上传模式下，总是清理  2. 或者：不需要在本地打开 且 没有指定输出路径
+ const shouldCleanup = forceOSSUpload || (!openIt && !output);
+ if (shouldCleanup && (uploadedToOSS || uploadedToMinio)) {
+     try {
+         await fs.unlink(filePath);
+         logger.info(`已清理本地临时HTML文件: ${filePath}`);
+     } catch (cleanupError) {
+         logger.warn(`清理临时HTML文件失败: ${cleanupError}`);
+     }
+ }
```

## 📊 修复后的预期结果

修复后，应该返回两个不同的链接：

```json
{
  "success": true,
  "downloadUrl": "https://aiagenttest.oss-cn-beijing.aliyuncs.com/markmap/xxx.html?Expires=...",
  "previewUrl": "http://page.thingotech.com.cn/page/xxx.html",
  "filename": "xxx.html",
  "timestamp": "2025-10-17T...",
  "message": "思维导图生成并上传成功（OSS + Minio）" // ✅ 双上传成功
}
```

**两个链接的区别**：

- `downloadUrl`: OSS 链接（长期有效，5年签名URL）
- `previewUrl`: Minio 链接（简短，快速访问）

## 🧪 验证步骤

1. 重新编译代码：`npm run build`
2. 重新发布版本：`npm version patch` 或直接发布 v0.2.9
3. 在 Claude Desktop 中测试
4. 验证返回值中的两个链接不同

## 📝 版本说明

- **Bug 版本**: v0.2.8
- **修复版本**: v0.2.9（待发布）
- **影响范围**: Minio 上传功能
- **严重程度**: 中等（核心功能正常，但缺少快速预览链接）

## 🎯 总结

这是一个典型的**时序问题**（Race Condition），由于过早地清理资源导致后续操作失败。修复方案很简单：**确保所有需要使用文件的操作完成后，再删除文件**。

---

**修复日期**: 2025-10-17  
**修复人员**: AI Assistant
